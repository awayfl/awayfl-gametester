<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <script type="text/javascript">
        var config_escaping_the_prison = {
            debug: true,
            width:1280,
            height:803,
            progressBar_left: 0.36,
            progressBar_top: 0.83,
            progressBar_width: 0.33,
            progressBar_height: 0.07,
            progressColor:"#ca0000",
            progressColorBG:"#000",
            splashScreenName: "assets/generic.jpg",
            skipFramesOfScene:1,
            skipFramesCallback:function(callback){
                window["PokiSDK"].commercialBreak().then(() => {
                        window["PokiSDK"].gameplayStart();
                        callback();
                    });
            },
            actionOnStop:{
                childName:"instance1349_4",
                action:()=>{
                    //console.log("PokiSDK gameplayStop")
                    window["PokiSDK"].gameplayStop();
                }
            },
            retryButtonIDS:{
                //retry
            },
            retryButtonAction:function(callback){
                window["PokiSDK"].commercialBreak().then(() => {
                        window["PokiSDK"].gameplayStart();
                        callback();
                    });
            },
            actionWhenRetryButtonEncountered:function(){
                    window["PokiSDK"].gameplayStop();
            },
            buttonPokiSDKActions:{
                "instance225_10":function(callback){
                    console.log("press start button");
                    callback();
                }
            },
            //overwrite these
            // swf: 'assets/escaping_the_prison.swf',
            // name: 'Escaping the prison',
            // swf_size: 8230598,
        };
        var config=config_escaping_the_prison;
        var jsFilesToLoad = [
            { name: "poki-sdk", path: "https://game-cdn.poki.com/scripts/v2/poki-sdk.js"},
            { path: "scripts/AVM1Player.js" }
        ];
        var filesToLoad = [
            { name: config.name, path: config.swf, bytesToLoad: config.swf_size }  
        ]

        var files_loaded=[];
        var jsFilesToLoadCount = jsFilesToLoad.length;
        var filesToLoadCount = filesToLoad.length;
        var jsFilesLoaded = 0;
        var percentageJSFiles = 20;
        var percentageSWFLOAD = 50;
        var bytesToLoadAll = 0;
        for (var i = 0; i < filesToLoad.length; i++) {
            bytesToLoadAll += filesToLoad[i].bytesToLoad;
        }

        var totalPercentComplete = 0;
        var loadedBytes = 0;
        var loadedBytesBeforeThisFile = 0;
        var loadJSFile = function (file) {
            var head = document.getElementsByTagName('head')[0];
            var script = document.createElement('script');
            script.type = 'text/javascript';
            script.onreadystatechange = function () {
                if (this.readyState == 'complete') jsSFileOnLoadPokiCheck(file);
            }
            script.onload = ()=>jsSFileOnLoadPokiCheck(file);
            script.src = file.path;
            head.appendChild(script);
        }
        
        var jsSFileOnLoadPokiCheck = function (file) {
            if (file.name == "poki-sdk") {

                PokiSDK.init().then(
                    () => {
                        // successfully initialized
                        PokiSDK.adBlocked=false;
                        //console.log("PokiSDK initialized");
                        PokiSDK.gameLoadingStart();
                        jsSFileOnLoad();
                    }
                ).catch(
                    () => {
                        // initialized but the user has an adblock
                        PokiSDK.adBlocked=true;
                        PokiSDK.gameLoadingStart();
                        jsSFileOnLoad();
                    }
                );
                PokiSDK.setDebug(true);
            }
            else {
                jsSFileOnLoad();
            }
        }
        var jsSFileOnLoad = function () {
            jsFilesLoaded++;
            updateProgressBar((jsFilesLoaded / jsFilesToLoadCount) * percentageJSFiles);
            if (jsFilesToLoad.length > 0) {
                loadJSFile(jsFilesToLoad.shift());
            }
            else {
                if (filesToLoad.length > 0) {
                    loadAFile(filesToLoad.shift());
                }
                else {
                    allLoadingDone();
                }
            }
        }
        var loadAFile = function (file) {
            function updateProgress(evt) {
                if (evt.lengthComputable) {
                    var percentComplete = (evt.loaded / evt.total) * 100;
                }
                else {
                    var percentComplete = (evt.loaded / file.bytesToLoad) * 100;
                }
                loadedBytes = loadedBytesBeforeThisFile + evt.loaded;
                totalPercentageComplete = percentageJSFiles + ((loadedBytes / bytesToLoadAll) * (percentageSWFLOAD - percentageJSFiles));
                updateProgressBar(totalPercentageComplete);
            }
            var req = new XMLHttpRequest();
            req.onprogress = updateProgress;
            req.open('GET', file.path, true);
            if(file.path.indexOf(".js")>0){
                req.responseType = "text";
            }
            else{
                req.responseType = "arraybuffer";
            }
            req.addEventListener('load', function (evt) {
                loadedBytesBeforeThisFile += file.bytesToLoad;
                updateProgressBar(percentageJSFiles + ((loadedBytesBeforeThisFile / bytesToLoadAll) * (percentageSWFLOAD - percentageJSFiles)));
                //console.log("preloaded file:"+file.path);
                if(file.path.indexOf(".js")>0){
                    //console.log("js-file preloaded", req.response);
                    eval(req.response);
                    /*
                    var script = document.createElement('script');
                    script.src = req.response; //put whatever javascript you like here
                    script.type = 'text/javascript';
                    document.getElementsByTagName('head')[0].appendChild(script);*/
                }
                else{                    
                    files_loaded.push({
                        data:req.response, 
                        name:file.name,
                        path:file.path,
                        skipFramesOnScene:config.skipFramesOfScene,
                        skipFramesCallback:config.skipFramesCallback,
                        buttonPokiSDKActions:config.buttonPokiSDKActions,
                        retryButtonIDS:config.retryButtonIDS,
                        retryButtonAction:config.retryButtonAction,
                        actionWhenRetryButtonEncountered:config.actionWhenRetryButtonEncountered,
                        actionOnStop:config.actionOnStop,
                        showPercentageWhenFinished:percentageSWFLOAD+((files_loaded.length+1)/filesToLoadCount*30),  
                        type:"swf"});
                }
                if (filesToLoad.length > 0) {
                    loadAFile(filesToLoad.shift());
                }
                else {
                    
                    if (!window["startAwayJSPlayer"])
                        throw ("Could not find a 'startAwayJSPlayer' method");
                    window["startAwayJSPlayer"](files_loaded);
                }
            });
            req.send();

        }

        var updateProgressBar = function (value) {
            var progressbar = document.getElementById("progressbar2");
            progressbar.style.width = value + "%";
            progressbar.style.backgroundColor = config.progressColor;
            var progressbar2 = document.getElementById("progressbar");
            progressbar2.style.backgroundColor = config.progressColorBG;
            
            if(PokiSDK){
                var data = {};
                data.percentageDone = value;
                PokiSDK.gameLoadingProgress(data);
            }

        }
        var allLoadingDone = function () {
            var progressbar = document.getElementById("progressbar");
            progressbar.style.display = "none";
            var splashscreen = document.getElementById("splash");
            splashscreen.style.display = "none";
            if(PokiSDK){
                PokiSDK.gameLoadingFinished();
            }
        }
        resizeScreen = function () {
            var newHeight = window.innerHeight;
            var newWidth = (config.width / config.height) * newHeight;
            if (newWidth > window.innerWidth) {
                newWidth = window.innerWidth;
                newHeight = newWidth * (config.height / config.width);
            }
            var splash = document.getElementById("splash");
            splash.style.left = ((window.innerWidth - newWidth) / 2) + "px";
            splash.style.top = ((window.innerHeight - newHeight) / 2) + "px";
            splash.style.width = newWidth + "px";
            splash.style.height = newHeight + "px";
            splash.style.visibility = "visible";
            var progressbar = document.getElementById("progressbar");
            progressbar.style.left = newWidth * config.progressBar_left + ((window.innerWidth - newWidth) / 2) + "px";
            progressbar.style.top = (newHeight * config.progressBar_top) + ((window.innerHeight - newHeight) / 2) + "px";
            progressbar.style.width = newWidth * config.progressBar_width + "px";
            progressbar.style.height = newHeight * config.progressBar_height + "px";
            progressbar.style.visibility = "visible";
        }


        window.onresize = () => resizeScreen();

        // make functions avilailable on window, so the loaded js-code can access and execute them
        window["updatePokiProgressBar"] = updateProgressBar;
        window["hidePokiProgressBar"] = allLoadingDone;

        function handleMessages(message){
            if(message.data.type === "sendSwfData"){
                config = Object.assign(config, message.data.swf);
                filesToLoad[0] = Object.assign(filesToLoad[0], {name: config.name, path: config.swf, bytesToLoad: config.swf_size });

                if(jsFilesToLoad.length>0)
                    loadJSFile(jsFilesToLoad.shift(), jsSFileOnLoad);
                else if(filesToLoad.length>0)
                    loadAFile(filesToLoad.shift());
            }
        }
        window.addEventListener('message', handleMessages);

        window.onload = () => {
            document.getElementById("splash").src=config.splashScreenName;
            resizeScreen();
        }


    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
        }
        
        canvas{
            outline:none
            } 

        html,
        body {
            margin: 0;
            overflow: hidden;
            width: 100%;
            height: 100%;
            background-color: black;
        }

        #progressbar {
            position: absolute;
            visibility: hidden;
            background-color: #000000;
            z-index: 999999999;

        }

        #progressbar2 {
            width: 0%;
            height: 100%;
            visibility: visible;
            background-color: #ca0000

        }

        #splash {
            position: absolute;
            visibility: hidden;
            z-index: 999999999;
        }
    </style>
</head>

<body>

    <title>Puffballs United</title>

    <img id="splash"></img>
    <div id="progressbar">
        <div id="progressbar2"></div>
    </div>


</body>

</html>
